# 1. Схема AБ-тестирования
```python
АБ разбиение (Б ~ 1%) </br>
Ждем 2 недели </br>
Вычисляем ключевые метрики </br>
Xu - число поисковых сессий юзера u </br>
Сравниваем статистику группы А и группы Б </br>
$ΔX = \overline{X}_Б - \overline{X}_А$ </br>
Для $\overline{X}_Б$ производим проверку: </br>
- статистический тест -> статистически значимый (разница вызвана шумом или изменениями)</br>
- существенность (положительный или негативный эффект) </br>
Принимаем решение </br>
Можем провести обратный АБ-тест - раскатить большему числу пользователей Б, а меньшему - А </br>
```
## Типичные метрики
* Уникальные пользователи за сессию
* Клики на пользователя, клики на один запрос
* Среднее время пользователя на сайте
* Возвращаемость пользователя</br>
...</br>
Офлайн метрики</br>
* Средний чек
* Средний трафик
* Средняя разница между ценой товара и его себестоимостью (маржа)

## Где используются АБ-тесты
* Изменение дизайна на сайте
* Изменение функциональности в играх
* Работоспособность лекарств
* Выкатка нового алгоритма машинного обучения
* Изменения в офлайн-магазинах: смена порядка отделов, раскладка товаров, установка постоматов, промо-акции

## Значимость и существенность
Значимость - статистический тест говорит нам, что изменения в метрике неслучайны</br>
Существенность - насколько изменения большие по своей величине, насколько большой размер эффекта (изменение метрики), который мы ловим </br>
<img src="images/размер эффекта.bmp" alt="Размер эффекта" width="500" height="300"></br>

## Резюме
АБ-тест используется для проверки идеи на группе пользователей. При проведении АБ-теста мы должны ответить на ряд вопросов:
1. Что является целевой метрикой?
2. На какое увеличение мы рассчитываем?
3. Какой критерий мы используем для проверки результата на статистическую значимость?
4. Как должен выглядеть дизайн эксперимента, как разбить пользователей на группы?
5. Как долго должен идти эксперимент?





# 2. Проблемы, возникающие при АБ-тестировании и способы их решить
## Схема АБ-теста
1. Фаза 1: планирование эксперимента и его дизайн
2. Фаза 2: сбор статистики и проверка гипотез

! Плохо спланированный дизайн эксперимента может привести к неверным выводам </br>
## Кейс про Cocacola
* Как на продажы колы влияет содержание сахара?
* Фокус-группы пробует напитки
* Обсчет показывает, что с напиток с сахаром больше нравится людям
* Содержание сахара повышают => больше прибыли

Что-то пошло не так..
* Исследование проходило не в тех условиях, в которых люди обычно пьют колу
* Если мы говорим про маленький стакан, то большее количество сахара нравится людям
* Если напиток постоянно употребляется в больших количествах, то большее количество сахара не нравится людям

<b> Мораль </b> Тестирование идей должно проходить в условиях максимально приближенных к реальности </br>














## Проблемы
1) Репрезентативность — это соответствие характеристик выборки характеристикам популяции или генеральной совокупности в целом. </br>
2) Проблема самоотбора (selection bias)</br>
Часто можно увидеть опросники, на которые человек может сам решать, отвечать и отправлять ли результаты опроса.
Такие опросы подвержены проблеме самоотбора. </br>
<b> Проблема:</b> Выборка окажется смещенной из-за самоотбора. Люди принимают решение, участвовать в опросе или нет. Занятые люди с большой зп явно не будут проходить этот опрос.
</br>
3) Скрытые переменные</br>

(на примере фермерского поля) </br>

Одна часть поля может быть более солнечной, под ней может лежать геотермальный источник.</br>

<b> Решение: </b> Разбиение поля на 2 части надо делать случайно, надо контролировать всевозможные сторонние факторы</br>

4) Связанные выборки</br>

В эксперименте может быть важен порядок, в котором человеку показывают разные варианты</br>

* В примере с колой, результат может зависеть от того, какой напиток человеку давали пробовать первым: сладкий или не сладкий</br>

* <b> Решение: </b>рандомизировать порядок и давать напитки каждому человеку в случайном порядке </br>

5) Проблема подглядывания (peeking problem)</br>
* Размер выборки для проведения АБ-теста должен быть определен заранее
* Нельзя! досрочно прерывать АБ-тесты, при достижении значимости на более маленькой выборке
* Нельзя! продолжать АБ-тест, если за изначально запланированный период значимого результата получить не удалось
* Нельзя! менять метрики/критерии по результатам подглядывания
* Можно! запустить новый эксперимент, на новых выборках

Если мы подглядываем, мы отвечаем на вопрос</br>
-- выходит ли разница в диапазон неразличимости хотя бы раз за все время тестирования?</br>
</br>
вместо
</br>
-- Значима ли разница, когда вся выборка будет собрана?

* Это завышает значение <i> pvalue </i>
* <b> Решение:</b> дождаться конца теста либо использовать специальные методологии. Например, байесовских многоруких бандитов
</br>
6) Неправильная работа с метриками</br>
* Неправильная интерпретация метрик </br>
<b> Пример (эффект новизны):</b> метрики растут из-за того, что новизна привлекает пользователей, но со временем они упадут
* Неправильный выбор метрик</br>
<b> Пример:</b> Британская Индия, проблема многочисленных кобр в Дели. Вознаграждение за каждую убитую змею. </br>
! Люди начали разводить кобр, чтобы получить вознаграждение
</br>
















7) Смещение из-за оптимизма (Optimism bias)</br>
Когда метрика изменяется <i> в хорошем направлении</i>, мы просто принимаем этот факт</br>
! У нас есть предрасположенность подвергать проверкам только неприятные выводы.</br>
8) Еще проблемы</br>
* АБ-тест длится меньше недели: поведение пользователей разные дни недели, присутствует сезонность
* Долгосрочные и краткосрочные эффекты
* Хочется проверять много идей сразу, один и тот же пользователь не должен попадать в несколько групп
* Проведение подновременно нескольких экспериментов: изменения могут взаимоуничтожать друг друга
* Неравномерный отбор пользователей в эксперимент искажает картину - нужно рандомизировать выбор
* Не всегда ясно, как улучшить сервис, гораздо понятнее, как все испортить
</br>

## АА-тест
* Иногда, чтобы понять насколько хорошим вышел дизайн эксперимента, проводят АА-тест
* Делим пользователей на две группы в соответствии с дизайном эксперимента
* Показываем обеим группам старый вариант
* Гипотеза о том, что метрики не изменились, должна не отвергаться, если она отвергается - с дизайном либо с разбиением на группы что-то не так
</br>

### Резюме
* Эксперимент нужно аккуратно планировать, вести и анализировать
* Пользователей надо разбивать на группы случайно
* Дизайн эксперимента надо тщательно продумывать так, чтобы он соответствовал максимально приближенным к реальности условиям
* Нельзя жульничать: подглядывать, обрывать эксперимент раньше времени
* <b> Помощь: </b>АА-тесты, историческая база экспериментов

# 3. АБ-тесты в офлайне, естественные эксперименты
### Пример: офлайн-ритейл
* Ограничение на количество магазинов
* Элементы выборки зависимы (чеки внутри магазина зависят друг от друга)
* Неоднородность магазинов: у каждого магазина свое среднее значение, свйо размер и трафик
* Элементы выборки не из одного распределения, а из разных: Перекресток у бизнес-центра и в жилом районе - разные магазины
### Офлайн АБ-тесты: ритейл
* Неоднородность по погоде: в разные погодные условия разный трафик
* Неоднородность по времени: в течение суток, по дням недели и времени года (праздники, сезонность, промоакции)

! Неоднородность увеличивает дисперсии, тяжелее делать выводы, с ней нужно бороться</br>
Часто сложно выделить тестовую группу так, чтобы она не отличалась по своим характеристикам от магазинов всей сети

<img src="images/офлайн частотн хар.bmp" alt="Плотность распределения" width="500" height="300"></br>

-> нужны специальные приемы, которые помогут повести АБ-тест корректно:

<b> Разбиение на группы: </b>

* Каждый магазин описывает какими-то параметрами
* Можем посчитать между ними расстояния и найти похожие друг на друга магазины
* Если магазины были похожи до АБ-теста, то скорее всего и после него они останутся похожими
* Универсального способа нет

<b> Проверка корректности: </b>
* АА-тесты: правда ли, что в выделенных нами группах до эксперимента нет значимых различий
* Искусственный эффект: добавляем его в одну из групп и убеждаемся, что тест его находит
* Есть и другие методики валидации

## Невозможность АБ-теста
Бывают ситуации, когда АБ-тест устроить невозможно

<b> Примеры: </b>
* Вызывает ли курение рак? Нельзя поделить людей на две группы и заставить одну из них курить в течение всей жизни.
* Простимулирует ли экономику снижение налога? Нельзя поделить экономику страны на 2 части.

Многие эксперименты запрещает этика. Многие запрещает суровая реальность.

! В таких ситуациях приходится работать с наблюдаемыми данными. Т.е. действовать в концепции естественного эксперимента








## Естестенный эксперимент
<b> Задача: </b> правда ли, что в более маленьких классах дети учатся лучше?

<b> Идеальный эксперимент:</b>

* Случайным образом поделить всех детей и обучающих их учителей на классы разного размера
* Проводить регулярное тестирование и сравнить различия в оценках

<b>Проблемы: </b>

* Родители хотят, чтобы их ребенок учился в маленьком классе и мешают эксперименту
* Очень дорого: 4-х летний проект STAR (~12 млн $)

<b>Проект STAR (вторая половина 80-х): </b> выборка резульатов тестов в n=420 школьных округах в Калифорнии

<b> Переменные:</b>

* средние результаты тестирования пятиклассников по округу (комбинация тестов по матиматике и чтению)
* соотношение учеников и учителей (число учеников в округе деленное на число учителей в округе)

<b> Задача: </b> понять как меняются результаты школьников (баллы за тест) в зависимости от размера класса, есть ли между этими переменными значимая связь?

### Линейная регрессия: статистический взгляд
<b> Задача: </b> понять как меняются результаты школьников (баллы за тест) в зависимости от размера класса, есть ли между этими переменными значимая связь?

<b> Модель:</b> $y_i = \beta_0 + \beta_1 * x_i + \epsilon_i $

$x_i$ - среднее значение размера класса в i-м округе

$y_i$ - среднее значение за тест в i-м округе

$\epsilon_i$ - прочие факторы, влияющие на результаты обучения в i-м округе

$\beta_0, \beta_1$ - коэффициенты линейной регрессии

<b> Если:</b>

* $E(\epsilon_i | x_i) = 0, $
* наблюдения независимы, одинаково распределены
* большие выбросы маловероятны

<b> Тогда </b> можно найти несмещенную, состоятельную и эффективную оценку $\widetilde{\beta_1}$ и проверить гипотезу о равенстве этого коэффициента нулю

<b> Проблема: </b>

* Есть еще десяток признаков, которые могут влиять на успеваемость детей
* Если учесть их влияние, останется ли влияние размера класса значимым

Этим занимается эконометрика

## Эконометрика
* Логическое продолжение статистики
* Пытается ответить на вопрос, как именно несколько переменных связаны между собой
* Пытается получить несмещенные, состоятельные и эффективные оценки для этих взаимосвязей
* Изучает методы оценки причинно-следственных связей и свойства этих методов


### Резюме

* В офлайне АБ-тесты делать сложнее, чем в онлайне
* На каждом этапе проведения эксперимента возникают проблемы
* Нужно быть аккуратнее с неоднородностью выборок, все результаты необходимо дополнительно валидировать
* Бывают ситуации, кодгда провести АБ-тест невозможно, но знать величину эффекта надо
* В таких ситуациях на помощь приходит эконометрика, которая помогает очистить эффект от влияния других переменных











# 4. Множественная проверка гипотез
## История о зомби-лососе
* Аппарат МРТ возвращает много данных
* Чтобы убедиться, что в мозгу нет реакции, надо проверить много гипотез об отсутствии активности на каждом маленьком участке мозга
### Проблема множественного тестирования:
Если мы проверяем несколько гипотез подряд, уровень значимости выходит из-под контроля

Мы начинаем чаще отвергать верные гипотезы, чем нам хотелось бы

<b> Проверяем две гипотезы:</b> Каждую на уровне значимости $\alpha$

$H_0: \mu_1 = \mu_2 = \mu_3$

<b> Можно ошибиться сразу в двух местах: </b>

P(ошибочно отвергнуть хотя бы одну из $H_0$) = 

$= 1 - Р(не ошибиться ни в одной) = 1 - (1 - \alpha)^2$

$= 1 - (1 - 2\alpha + \alpha^2) = 2\alpha - \alpha^2 > \alpha$

$\alpha_i = 0.05 => \alpha = 0.1 - 0.025 = 0.075 > 0.5$

! Вероятность ошибки первого рода накапливается и выходит из-под контроля

* Требуется протестировать несколько изменений и их комулятивное воздействие на продуктовые метрики.

<b> Пример: </b> показ на странице сервиса нескольких новых элементов

* Изменения взаимосвязаны и их можно протестировать только на одном временном промежутке
* В такой ситуации мы сталкиваемся с множественным тестированием
* С ростом числа гипотез, вероятность получить ошибку растет экспоненциально: $1 - (1 - \alpha)^n$

! Нужно взять уровень значимости под контроль

Для этого есть разные процедуры корректировки..

## Неравенство Бонферрони
* Нужно как-то скорректировать исходный уровень значимости, в этом помогает неравенство Бонферрони:

$P(A + B) \leq P(A) + P(B)$

* То есть каждую гипотезу из двух надо проверять на уровне значимости $\alpha/2$

$\alpha$ = P(ошибочно отвергнуть хотя бы одну из $H_0$)

$\leq$ P(ош.в 1) + P(ош.во 2) = $\alpha_i/2 + \alpha_i/2 = \alpha_i$

* Если гипотез k, берем уровень значимости $\alpha/k$ для каждой

* Из-за корректции уровня значимости возникают проблемы с мощностью тестов

* Чем больше гипотез провер

Продолжение лекций тут https://www.youtube.com/watch?v=UzUrXDQXmzc 

# 5. Как понять, сколько нужно данных для проведения эксперимента

# 6. Метрики для АБ-тестирования
<b> </b>
